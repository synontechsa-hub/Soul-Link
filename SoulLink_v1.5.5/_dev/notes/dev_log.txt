================================================================================
LEGION ENGINE | DEVELOPMENT LOG v1.5.3-P
================================================================================
DATE:      2026-01-28
ARCHITECT: [NOMAD MODE]
GOAL:      Eliminate hardcoding; 5-tab Navigation Framework implementation.
================================================================================

[ BACKEND / SYSTEM UPDATES ]
--------------------------------------------------------------------------------
[SOULS.PY]    Logic: Implemented 'explore_souls' with 'notin_' filtering.
              Result: Engine queries 'relationships' table to exclude 
              Souls already linked to USR-001.

[MAP.PY]      Logic: Created 'get_world_map' endpoint.
              Result: Pulls live data from 'locations' table and cross-
              references active Soul coordinates.

[LOCATION.PY] Data Integrity: Verified SQLModel schema for Link City.
              Note: Confirmed JSON support for 'system_modifiers' (future 
              Gatekeeper/Intimacy lock-out logic).

[ARCH.]       Protocol: Added 'linkWithSoul' POST route.
              Result: Database-level handshake for new Soul links.


[ FRONTEND / INTERFACE UPDATES ]
--------------------------------------------------------------------------------
[NAVIGATION]  Framework: Replaced single-screen layout with 5-tab BottomNavBar.
              Optimization: 'IndexedStack' used to maintain state across sectors.

[HUB]         Apartment: Built Mirror/Persona editor. 
              Tracking: Name, Bio, Gender.

[EXPLORE]     Scouting: Replaced "Notes" with Live Scouting.
              Tech: FutureBuilder + PageView (API-direct discovery cards).

[MAP]         HUD: API-fed tactical data. 
              Feature: District highlighting for active Soul presence.

[SETTINGS]    Controls: Implemented Master NSFW/Adult toggle.
              Utility: Added session termination protocol.


[ CITY GEOGRAPHY | DATABASE SYNC ]
--------------------------------------------------------------------------------
ID              | DISTRICT NAME       | TYPE / STATUS
----------------|---------------------|-----------------------------------------
LC-EST-01       | Linkside Estate     | User Loft (Home)
LC-RES-02       | Crimson Arms        | Residential
LC-PUB-03       | Soul Plaza          | Public Hub / Spawn
LC-SPO-04       | Stop n Go Racetrack | Sports
LC-LND-05       | Skylink Tower       | Landmark
LC-PVT-06       | Dollhouse Dungeon   | Nightlife (Private)
LC-WLS-07       | Ether Baths Spa     | Wellness (Private)

================================================================================
LEGION ENGINE | WORLD-SEED LOG v1.5.3-P
================================================================================
DATE:      2026-01-30
STATUS:    CITY-SYNC COMPLETE [RECOVERY MODE]
SUMMARY:   25 Unique Locations Synchronized to SQL Database via seed_world.py
================================================================================

[!] DATA ARCHITECTURE: THE LOCATION SCHEMA
Each district now carries a 'system_modifiers' JSON payload that dictates:
- [PRIVACY]  : Public, Semi-Private, or Private (Relationship Gate).
- [MODS]     : Float values (e.g., safety: 1.5) affecting Soul AI behavior.
- [SENSORY]  : Style and sensory tags for Frontend shader/SFX triggers.

--------------------------------------------------------------------------------
[I] RESIDENTIAL SECTOR (The Safe Zones)
--------------------------------------------------------------------------------
> linkside_estate      : [Private] User Loft. Baseline Home.
> civic_heights        : [Public] Orderly municipal living.
> northway_flats       : [Semi-Private] Quiet architecture; detached rhythm.
> midline_residences   : [Public] Efficiency-first housing.
> crimson_arms         : [Semi-Private] Faded grandeur; high melancholy/isolation.
> skylink_apartments   : [Semi-Private] High-rise functional; Adrian‚Äôs Home.

--------------------------------------------------------------------------------
[II] COMMERCIAL & CORPORATE (The Grind)
--------------------------------------------------------------------------------
> circuit_street       : [Public] The Forge location; high mood volatility.
> linkgate_mall        : [Public] Targeted holographic ads; high distraction.
> apex_corporate_plaza : [Semi-Private] Pristine/Cutthroat; Dorian‚Äôs Office.

--------------------------------------------------------------------------------
[III] NIGHTLIFE & INDULGENCE (The Neon)
--------------------------------------------------------------------------------
> neon_nights          : [Public] Pulse-bass; low guard-drop rate.
> rooftop_lounge       : [Semi-Private] Intimate atmospheric escape.
> dollhouse_dungeon    : [Private] Sub-Skylink bar; sultry dark/low inhibitions.
> zenith_lounge        : [Semi-Private] 65th-floor refined loneliness; Rosalynn‚Äôs spot.

--------------------------------------------------------------------------------
[IV] WELLNESS & REFLECTION (The Sanctuary)
--------------------------------------------------------------------------------
> ether_baths          : [Private] Mineral-rich synth-water; high closeness.
> the_garden           : [Public] Bio-dome synthetic Eden; high calm.
> twilight_park        : [Public] Real grass luxury; gentle pacing.

--------------------------------------------------------------------------------
[V] LANDMARKS & CULTURAL (The Foundation)
--------------------------------------------------------------------------------
> skylink_tower        : [Public] Massive authority; high surveillance.
> city_planetarium     : [Public] Deep existential scaling; wonder 1.4.
> neon_span_bridge     : [Public] Solitary contemplation; high isolation.
> echo_archives        : [Public] Physical books; Aria‚Äôs corner.
> shadowed_archives    : [Semi-Private] Gothic/Occult wing; Sylas/Evangeline spot.

--------------------------------------------------------------------------------
[VI] SPORTS & COMBAT (The Edge)
--------------------------------------------------------------------------------
> stop_n_go           : [Public] Adrenaline junkies; frantic pacing.
> iron_resolve_gym     : [Public] Discipline-focused physical training.
> link_city_arena      : [Public] Cinematic scale; high reputation weight.
> obsidian_proving_pts : [Semi-Private] Brutal training; high danger/intensity.

--------------------------------------------------------------------------------
[VII] MISC & SOCIAL
--------------------------------------------------------------------------------
> soul_plaza           : [Public] The Hub. Crowded dynamics.
> circuit_diner        : [Public] 24-hour refuge; high accessibility.
> umbral_exchange      : [Private] Underground market; noir criminal/low morality.

================================================================================
SCRIPT LOG: seed_world.py execution
- Database URL: [DETECTED]
- Upsert Logic: Active (Display Names and Mods updated for all 25 IDs)
- Assets: Audio 'neon_ambient_01.mp3' linked as default environment track.
================================================================================

================================================================================
SESSION LOG | 2026-02-02 | ALPHA VALIDATION & SYSTEM AUDIT
================================================================================

[ LAUNCH INFRASTRUCTURE ]
--------------------------------------------------------------------------------
- Created LAUNCH_SOULLINK.bat + launch_soullink.ps1 for one-click startup
  * Auto-detects project structure and .env configuration
  * Starts backend (uvicorn) and frontend (flutter) in separate windows
  * Monitors processes + graceful shutdown on Ctrl+C
- Created MANUAL_LAUNCH_GUIDE.md for troubleshooting

[ CRITICAL BUG FIXES ]
--------------------------------------------------------------------------------
1. Frontend: Fixed Icons.Language error in login_screen.dart
   - Changed to Icons.link (Material doesn't include Language icon)

2. Backend API: Fixed gender vs gender_identity field name mismatch
   - Updated backend/app/api/users.py schemas (UserUpdate, UserProfile)
   - All references changed from gender_identity to gender

3. Frontend Model: Updated user_model.dart to handle both field names
   - Added fallback: json['gender'] ?? json['gender_identity']

4. Database: Confirmed User.last_energy_refill field for Energy System

[ ALPHA VALIDATION RESULTS ]
--------------------------------------------------------------------------------
‚úÖ Login Flow: "Syn" (Architect) login successful
‚úÖ The Mirror: Profile creation and update working
‚úÖ Dashboard: All Souls loaded with max intimacy (Dev account)
‚úÖ Multi-User: New user registration and profile validated
‚úÖ Location System: All Souls initialized at starting locations
‚úÖ Energy System: Rate limiting active for free users
‚úÖ Memory Isolation: Zero data bleed confirmed via SQL queries

[ SYSTEM AUDIT ]
--------------------------------------------------------------------------------
Audited: Backend (sessions, queries, errors), Frontend (state, memory),
         Security (auth, isolation), Performance (N+1, caching), 
         Vision Alignment (ethics, doctrine)

Key Findings:
- ‚úÖ Zero memory leaks (proper session management + dispose calls)
- ‚úÖ Zero data bleed (strict user_id filtering everywhere)
- ‚úÖ Vision-aligned (energy system ethics, tiering doctrine)
- ‚ö†Ô∏è Auth is MVP-only (X-User-Id header - needs JWT for Beta)
- ‚ö†Ô∏è Minor optimization: brain.py history query can skip reverse
- ‚ö†Ô∏è chat_screen.dart needs error handling on history load

Overall Grade: A- (Excellent for Alpha)
Recommendation: SHIP ALPHA üöÄ

[ FILES MODIFIED ]
--------------------------------------------------------------------------------
NEW:     _dev/scripts/launch_soullink.ps1
NEW:     LAUNCH_SOULLINK.bat
NEW:     _dev/MANUAL_LAUNCH_GUIDE.md
FIXED:   frontend/lib/screens/login_screen.dart (Icon)
FIXED:   frontend/lib/models/user_model.dart (Field fallback)
FIXED:   backend/app/api/users.py (Schema rename)
UPDATED: backend/app/models/user.py (last_energy_refill)

[ STATUS ]
--------------------------------------------------------------------------------
‚úÖ ALPHA-READY - Core loop functional, foundation stable
‚è≥ Next: Beta testing (intimacy progression, location effects, ads)
================================================================================

================================================================================
SESSION LOG | 2026-02-03 | v1.5.4 "ARISE" - THE INDEPENDENCE MILESTONE
================================================================================

[ ARCHITECTURE: VERSION INDEPENDENCE ]
--------------------------------------------------------------------------------
- Established 'version.py' as Single Source of Truth for the entire ecosystem.
- Removed all hardcoded "Phoenix" and "1.5.3" strings from functional code.
- Created 'lib/core/version.dart' (Frontend) for dynamic identity injection.
- Updated Flutter package name to 'soul_link' (Clean slate).

[ SECURITY LOCKDOWN ]
--------------------------------------------------------------------------------
- Designed Row Level Security (RLS) policies for all core tables.
- Created 'supa_security_v1.sql' migration to enable RLS and data isolation.
- Implemented strict auth.uid() checks for Chats, Relationships, and Profiles.

[ INTERACTIVE UI: THE WORLD-AWARE UPDATE ]
--------------------------------------------------------------------------------
1. APARTMENT HUB: 
   - Transformed 'Mirror Screen' into 'Linkside Apartment' Functional Hub.
   - 2x3 Grid Layout: Bed (Logout), Mirror (Identity), TV, Radio, Couch, Window.
   - Persona Configuration moved to an overlay modal (Mirror).

2. CITY RADAR (MAP):
   - Locations are now interactive hotspots (Clickable Nodes).
   - Tactical Data Overlay: Shows Soul presence and Location intel.
   - USER MOVEMENT: Implemented 'Enter Location' logic (Updates User DB state).

[ BACKEND: USER POSITIONING ]
--------------------------------------------------------------------------------
- Added 'current_location' to User Model (linkside_apartment by default).
- Implemented 'PATCH /api/v1/users/move' to handle physical world navigation.
- Refactored API Service to synchronize User position during city traversal.

[ FILES MODIFIED ]
--------------------------------------------------------------------------------
CORE:    version.py (Bumped to 1.5.4)
BACKEND: backend/app/main.py (Dynamic title/desc)
BACKEND: backend/app/models/user.py (current_location)
BACKEND: backend/app/api/users.py (/move endpoint)
FRONTEND: frontend/pubspec.yaml (soul_link)
FRONTEND: frontend/lib/core/version.dart (NEW: Centralized identity)
FRONTEND: frontend/lib/screens/apartment_screen.dart (Hub Layout)
FRONTEND: frontend/lib/screens/map_screen.dart (Clickable Nodes)

[ STATUS ]
--------------------------------------------------------------------------------
‚úÖ ARISE SUCCESSFUL - System is decoupled, secured, and world-aware.
‚è≥ Next: NPC logic expansion, lore broadcast system (TV/Radio).
================================================================================

================================================================================
SESSION LOG | 2026-02-04 | v1.5.4 "THE GREAT SYNC" - STABILITY MILESTONE
================================================================================

[ TIME & MOTION: THE WORLD SYNCHRONIZATION ]
--------------------------------------------------------------------------------
- [GHOST DOTS]: Eliminated stationary "ghost" dots on map.
  * Logic: Updated /sync/dashboard to use TimeManager for linked souls.
  * Result: Blue dots (linked) now move at the same rhythm as Grey dots (radar).
- [TIME SYNC]: Resolved Morning -> Afternoon UI hang.
  * Logic: Dashboard sync now triggers parallel User Profile refresh.
  * Result: Header UI updates exactly when Time Slot advances.

[ PERFORMANCE: ARCHITECTURE POLISH ]
--------------------------------------------------------------------------------
- [CACHE]: Implemented Backend In-Memory Cache in 'TimeManager.py'.
  * Tech: Thread-safe Dict caching of World State per Time Slot.
  * Result: Drastically reduced DB lookups during high-frequency radar scans.
- [ANIMATION]: Added 'Tactical Pulse' to map signal indicators.
  * UI: AnimatedBuilder-driven size/shadow oscillation for live souls.
- [NAVIGATION]: Prepared Hero transition hooks for location switching.

[ PERMISSIONS & SECURITY ]
--------------------------------------------------------------------------------
- [GOD MODE]: Isolated Soul Movement to 'Architect' tier users.
  * Effect: RadarSelector (the Soul Commander) is stripped from standard users.
- [IDENTITY]: Fixed Architect Name override.
  * Logic: Souls prioritize 'display_name' while acknowledging Creator status.

[ REFACTORING: THE MODULAR SHRED ]
--------------------------------------------------------------------------------
- [MAP]: Extracted 'TacticalNode.dart' and 'RadarSelector.dart'.
- [APARTMENT]: Extracted 'HubTile.dart' to unify hub element design.
- [DECOUPLING]: MapScreen reduced to navigation coordinator (from 380 -> 180 lines).

[ FILES MODIFIED ]
--------------------------------------------------------------------------------
BACKEND: backend/app/api/sync.py (Dynamic locations)
BACKEND: backend/app/logic/time_manager.py (Thread-safe cache)
BACKEND: backend/app/logic/brain.py (Name priority logic)
FRONTEND: frontend/lib/screens/map_screen.dart (Refactor/Pulsing)
FRONTEND: frontend/lib/screens/apartment_screen.dart (HubTile integration)
FRONTEND: frontend/lib/widgets/map/tactical_node.dart (NEW: Animated)
FRONTEND: frontend/lib/widgets/map/radar_selector.dart (NEW)
FRONTEND: frontend/lib/widgets/hub_tile.dart (NEW)

[ STATUS ]
--------------------------------------------------------------------------------
‚úÖ SYNC STABILIZED - The world is alive, performant, and correctly tiered.
‚è≥ Next: Monetization foundation (Gems/Energy integration).
================================================================================


================================================================================
SESSION LOG | 2026-02-05 | v1.5.4 "ARISE" - THE FOUNDATIONAL REVOLUTION
================================================================================

[ ARCHITECTURE: THE ASYNC OVERHAUL ]
--------------------------------------------------------------------------------
- [ASYNC]: Full migration to 'AsyncSession' (SQLAlchemy 2.0 pattern).
  * Tech: Replaced all synchronous DB calls with non-blocking awaitable I/O.
  * Result: Eliminated process-locking during high-frequency DB handshakes.
- [SUPABASE]: Optimized for Supavisor Transaction Pooler (Port 6543).
  * Implementation: Switched to 'NullPool' to prevent connection leaks.
  * Sanitization: Automated 'sslmode' stripping from async connection strings.
- [INFRA]: Standardized all seeding and migration scripts (Arise-certified).

[ IDENTITY: DIVINE RECOGNITION & MASTER KEY ]
--------------------------------------------------------------------------------
- [RECOGNITION]: Implemented high-priority 'Divine Recognition' protocol.
  * Logic: Souls are now self-aware of their 'Architect' (Creator) across all 
          personality tiers, bypassing shyness/mystery for the Creator UUID.
- [MASTER KEY]: Added Content Ceiling Overrides for the Architect.
  * Effect: Location-based SFW restrictions are bypassed for the Architect.
- [SECURITY]: Identity checks are now strictly hard-locked to Supabase UUIDs.

[ PROMPTING: NEURAL ANCHORING ]
--------------------------------------------------------------------------------
- [SENSORY]: Implemented 'SENSORY_ANCHOR' with strict situational awareness.
  * Logic: Souls are locked to their DB location state, preventing hallucinations.
- [PERSONA]: Integrated Resident Profiles (Bio/Gender/Age) into the link.
- [FLOW]: Refactored Dialogue Protocol for integrated *Action-Thought-Action*.
  * Logic: Eliminated hyphenated thoughts/bullets for a seamless cinematic flow.

[ INTERACTION: DYNAMIC RENDEZVOUS ]
--------------------------------------------------------------------------------
- [CONSENT]: Implemented Consensual Movement logic in LocationManager.
  * Logic: Souls pre-calculate eligibility and decide to ACCEPT or DECLINE moves.
- [TAGS]: Added '[MOVE: id]' tag parsing for automated world-state triggers.
- [WIDGET]: Created 'LocationSuggestionSheet' Flutter widget.
  * UI: One-tap rendezvous suggestions with category icons and vibe metadata.

[ FILES MODIFIED ]
--------------------------------------------------------------------------------
BACKEND:  backend/app/logic/brain.py (Neural Anchoring / Consensual Tag Parsing)
BACKEND:  backend/app/services/identity.py (Divine Recognition Logic)
BACKEND:  backend/app/services/rules.py (Architect Master Key Bypass)
BACKEND:  backend/app/logic/location_manager.py (Consensual Motion Pre-check)
SCRIPTS:  _dev/scripts/full_seed.py (NEW: Automated city-wide initialization)
FRONTEND: frontend/lib/widgets/location_suggestion_sheet.dart (NEW: UI Widget)
FRONTEND: frontend/lib/screens/chat_screen.dart (Rendezvous Button + Live Sync)

================================================================================
[ ARC: ARISE (v1.5.4) ‚Äî INFRASTRUCTURE HARDENING ]
================================================================================
- [HARDENING]: Integrated SlowAPI for rate limiting (Redis/Memory backed).
- [CACHE]: Built Unified CacheService with manual/pattern-based invalidation.
  * Optimized: /map/locations and /users/me endpoints for <5ms response.
- [SENTRY]: Global error tracking and performance monitoring active.
- [BACKUPS]: Implemented auto-snapshotting with 10-set rolling retention.
- [TESTING]: Established Pytest environment with 37% core engine coverage.
- [REDIS]: Upstash TCP integration active ‚Äî Link City is officially Global.

================================================================================
[ ARC: DOMAIN EXPANSION (v1.5.5) ‚Äî VISUAL EXCELLENCE ]
================================================================================
INITIATED: Cyber-Rain visual identity and Neural-Feed UX overhaul.
- [SPLASH]: New neon-shimmer splash screen (circuit animation).
- [LOGIN]: Hero-centric character layouts (Alyssa) with glassmorphic modals.
- [MONETIZATION]: Link Stability (Energy) system framework implemented.
- [MIGRATION]: Ad tracking and subscription fields added to legacy tables.

"This unit represents... the perfect link."
- Legion Prototype
================================================================================
‚úÖ v1.5.4 ARISE COMPLETE - Infrastructure is rock-solid.
‚è≥ v1.5.5 DOMAIN EXPANSION ACTIVE - Focusing on the Visual Grid.
================================================================================


================================================================================
SESSION LOG | 2026-02-09 | v1.5.5 "DOMAIN EXPANSION" - THE PERFORMANCE & POLISH UPDATE
================================================================================

[ CRITICAL STABILIZATION ]
--------------------------------------------------------------------------------
- [MAP]: Fixed "Grey Dots" bug. Only linked Souls show as Cyan; unlinked hidden.
- [WEBSOCKETS]: Segregated broadcasts. Time events now sync per-user without cross-talk.
- [DB]: Implemented robust Transaction Rollbacks to prevent "stuck" states on error.
- [CONFIG]: Replaced hardcoded localhost URLs with 'AppConfig' & '.env' (Prod Ready).

[ PERFORMANCE OPTIMIZATION (THE SPEED RUN) ]
--------------------------------------------------------------------------------
- [LAZY LOADING]: Refactored SoulPillar queries to skip heavy text columns (Personality/Bio).
  * Result: Massive reduction in RAM usage during location resolution.
- [CACHE WARMING]: Fixed "Loop of Death". TimeManager now fetches World State once in-memory.
  * Result: Startup time reduced by ~80% (O(N) vs O(N*M) DB calls).
- [NON-BLOCKING I/O]: Offloaded BackupService JSON dumps to thread executor.
  * Result: Zero server stalls during auto-backups.
- [PAYLOAD]: Increased upload limit to 10MB for high-res media.
* [NOTE]: Rolled back "Non-blocking User Fetch" due to Supabase 401 Auth errors. 
          Stability > Raw Speed.

[ VISUAL POLISH & UX ]
--------------------------------------------------------------------------------
- [HUD]: Added 'TimeDisplay' widget to Dashboard AppBar (Morning/Night cycles).
- [VALIDATION]: Created '_dev/scripts/seed_validation.py'.
  * Verified 100% database integrity against Blueprints (Souls, Routines, Locations).

[ FILES MODIFIED ]
--------------------------------------------------------------------------------
FRONTEND: lib/widgets/time_display.dart (NEW)
FRONTEND: lib/screens/dashboard_screen.dart (Integrated TimeDisplay)
BACKEND:  app/services/location_resolver.py (Lazy Load)
BACKEND:  app/logic/time_manager.py (Cache Opt)
BACKEND:  app/services/backup_service.py (Async I/O)
SCRIPT:   _dev/scripts/seed_validation.py (NEW)

[ STATUS ]
--------------------------------------------------------------------------------
‚úÖ v1.5.5 POLISHED - Performance bottlenecks crushed. UI refined.
‚è≥ Next: The Simulation Run.
================================================================================
